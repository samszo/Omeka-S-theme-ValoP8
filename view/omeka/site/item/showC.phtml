<?php
// 1. Récupérer le service de recherche et l'adaptateur Solr
$searchManager = $this->getServiceLocator()->get('Omeka\Search\SearchManager');
$adapter = $searchManager->getAdapter('solr'); // Assurez-vous que votre adaptateur se nomme 'solr'

// 2. L'ID de l'item actuel dans Solr (souvent préfixé par Omeka)
$solrId = 'item_' . $item->id(); 

if ($adapter) {
    // 3. Construire la requête brute vers Solr pour le MLT
    // On utilise l'API client Solr sous-jacente
    $client = $adapter->getClient();
    
    // Paramètres spécifiques MoreLikeThis
    $query = $client->createSelect();
    $query->setQuery('id:"' . $solrId . '"'); // On cible l'item actuel
    $query->setHandler('mlt'); // On appelle le handler configuré à l'étape 2
    
    // Champs à analyser pour la similarité
    // ATTENTION : Remplacez par VOS noms de champs réels dans Solr
    $query->addParam('mlt.fl', 'dcterms_title_txt,dcterms_description_txt,dcterms_subject_ss');
    
    $query->addParam('mlt.mindf', 1); // Min Doc Frequency
    $query->addParam('mlt.mintf', 1); // Min Term Frequency
    $query->setRows(3); // Nombre de recommandations

    try {
        $resultset = $client->select($query);
        
        if ($resultset->getNumFound() > 0) {
            echo '<h3>Vous aimerez aussi (Suggestions Solr) :</h3>';
            echo '<div class="recommendations">';
            foreach ($resultset as $document) {
                // Le document Solr contient l'ID Omeka réel (ex: "item_105")
                // Il faut parser l'ID pour créer un lien
                $recId = str_replace('item_', '', $document->id);
                
                // Affichage simple (Titre récupéré de Solr)
                // Note: les champs multivalués sont des tableaux dans Solr
                $titre = is_array($document->dcterms_title_txt) ? $document->dcterms_title_txt[0] : 'Sans titre';
                
                echo '<div class="rec-item">';
                echo '<a href="' . $this->url('site/resource-id', ['resource-id' => $recId, 'controller' => 'item']) . '">' . $titre . '</a>';
                echo '</div>';
            }
            echo '</div>';
        }
    } catch (\Exception $e) {
        // Silencieux en prod, ou echo $e->getMessage() en dev
    }
}
?>